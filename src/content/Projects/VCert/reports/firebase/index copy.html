<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rise Sample - Database</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  <style>
    body {
      background-image: url(assets/1-2_bg.png);
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }

    #database {
      width: 80%;
      margin: 5em;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 15px;
      -webkit-box-shadow: 5px 5px 15px 5px rgb(0 0 0 / 10%);
      box-shadow: 5px 5px 15px 5px rgb(0 0 0 / 10%);
      margin-left: auto;
      margin-right: auto;
    }

    .key-label {
      font-weight: bold;
      display: inline;
    }

    .btn {

    }

    .hide {
      display: none;
    }

    #popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .expand-btn {
      cursor: pointer;
      text-decoration: underline;
      color: blue;
      margin-bottom: 0;
    }

    .expand-btn:hover {
      text-decoration: none;
    }

    .data-table {

    }

    .expanded .data-table {
      display: table;
    }

    .expanded .expand-btn {
      display: none;
    }

    .download-btn {
      display: inline-block;
      margin-top: 10px;
      cursor: pointer;
      text-decoration: underline;
      color: blue;
    }

    .download-btn:hover {
      text-decoration: none;
    }
    .expand-btn {
      cursor: pointer;
      text-decoration: underline;
      color: blue;
    }

    .expand-btn:hover {
      text-decoration: none;
    }

    .data-table {
      display: table;
      margin-top: 10px;
    }

    .expanded .data-table {
      display: table;
    }

    .modal-content {
      background-color: #ffffff;
      border-radius: 10px;
    }
  </style>
</head>

<body id="registrationPage">

  <!-- <div id="database" class="hide">

    <button type="button" class="btn btn-secondary float-right" onclick="downloadCsv();">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
      </svg>
    </button>
  </div> -->

  <button id="downloadBtn" class="btn btn-primary" onclick="downloadCsv();">Download 2 Week Summary</button>

  <button id="downloadBtn-2" class="btn btn-primary">Download CSV</button>

  <!-- Modal -->
  <div class="modal fade" id="popupModal" tabindex="-1" role="dialog" aria-labelledby="popupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="popupModalLabel">Class Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="popup-content"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>

  <script src="scripts/polyfill.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-populate/4.3.0/xlsx-populate.min.js"></script>


  <script>


$(document).ready(function(){
    $('#popupModal').modal();
});


$(function() {
  // Your Firebase configuration
      // Your Firebase configuration
      const firebaseConfig = {
  apiKey: "AIzaSyBV7dN8jF3nggPnJuzzWmT5MsiMjWmuz88",
  authDomain: "vcert-9568e.firebaseapp.com",
  databaseURL: "https://vcert-9568e.firebaseio.com",
  projectId: "vcert-9568e",
  storageBucket: "vcert-9568e.appspot.com",
  messagingSenderId: "701025120825",
  appId: "1:701025120825:web:7bf1e3dfd38637652c93e8",
  measurementId: "G-1N0PQ39K3P"
};

var jsonData, jsonData2; // Declare jsonData globally

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  var dataArray = [];

  const userDataRef = firebase.database().ref("ProductionUserGroup").orderByKey();
  userDataRef.once("value")
    .then(function(snapshot) {
      const promises = [];

      snapshot.forEach(function(childSnapshot) {
        const key = childSnapshot.key;
        const childData = childSnapshot.val();

        var thisTitle = String(key);
        console.log(thisTitle);

        dataArray.push({ key: key, data: childData });
        promises.push(Promise.resolve()); // You can push other promises if needed
      });

      // Wait for all promises to resolve
      return Promise.all(promises);
    })
    .then(function() {
      // This code will execute after the forEach loop finishes
      console.log("forEach loop finished");
      console.log(dataArray); // Process your dataArray here or call a function
      // Assign dataArray to jsonData
      // Function to convert JSON data to new format
      function convertJson(jsonData) {
        const newArray = [];
        jsonData.forEach(obj => {
          const data = obj.data;
          // Check if email is vcertadmin@thelhtgroup.com and skip processing if true
          if (data.Email === "vcertadmin@thelhtgroup.com") {
            return;
          }
          const classes = [];
          if (data.ClassHD) {
            classes.push({ type: "HD", date: data.ClassCompletionHD });
          }
          if (data.ClassLD) {
            classes.push({ type: "LD", date: data.ClassCompletionLD });
          }
          if (data.ClassVPS) {
            classes.push({ type: "VPS", date: data.ClassCompletionVPS });
          }

          classes.forEach(classData => {
            const totalChallengesCompleted = Object.keys(data[`c${classData.type}`])
              .filter(key => key.startsWith('c') && data[`c${classData.type}`][key] === 1)
              .length;

            const newObj = {
              "First Name": data.FirstName || "",
              "Last Name": data.LastName || "",
              "Company": data.Company || "",
              "VCERT Class": data.VCERTClass || "",
              "Email Address": data.Email || "",
              "Number of Challenges Completed": totalChallengesCompleted || 0,
              "Point Total": data[`TotalPoints${classData.type}`] || 0,
              "Ranking": data.Ranking || "",
              "Class Type": `Class ${classData.type} - ${classData.date}`
            };
            newArray.push(newObj);
          });
        });
        return newArray;
      }

      // Convert JSON data to new format
      const convertedData = convertJson(dataArray);
      console.log(convertedData);

      jsonData = convertedData;

      // Get the download button element by its ID
      var downloadBtn = document.getElementById("downloadBtn");
      console.log(downloadBtn)
      // Remove the disabled property
      downloadBtn.disabled = false;

      downloadBtn.addEventListener('click', function() {
        console.log("clicked")
        const csvContent = "data:text/csv;charset=utf-8," +
          Object.keys(jsonData[0]).join(",") + "\n" + // Header row
          jsonData.map(entry => Object.values(entry).join(",")).join("\n");

        // Create a temporary anchor element
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "2_week_report_date.csv");

        // Append anchor to the body and trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });


    //------------------------------------------------------------------------------------------
// Function to generate HTML content for the modal
function generateModalContent(groupedData) {
  let modalContent = '';
  Object.keys(groupedData).forEach(key => {
    const dataArray = groupedData[key];
    modalContent += `<div class="popup-item">`;
    modalContent += `<h3 class="expand-btn" data-toggle="collapse" data-target="#data-${key}">${key}</h3>`; // Date as expand button
    modalContent += `<div id="data-${key}" class="collapse">`;
    modalContent += '<table class="data-table">';
    // Header row
    modalContent += '<tr>';
    Object.keys(dataArray[0]).forEach(column => {
      modalContent += `<th>${column}</th>`;
    });
    modalContent += '</tr>';
    // Data rows
    dataArray.forEach(entry => {
      modalContent += '<tr>';
      Object.values(entry).forEach(value => {
        modalContent += `<td>${value}</td>`;
      });
      modalContent += '</tr>';
    });
    modalContent += '</table>';
    modalContent += `<button class="btn btn-primary download-btn" onclick="downloadTableCsv()">Download CSV</button>`;
    modalContent += `</div>`;
    modalContent += `</div>`;
  });
  return modalContent;
}
// Function to display the modal with the generated HTML content
function displayModal(modalContent) {
  document.getElementById('popup-content').innerHTML = modalContent;
  $('#popupModal').modal('show');
}

// Event listener for downloadBtn-2
const downloadBtn2 = document.getElementById("downloadBtn-2");
downloadBtn2.addEventListener('click', async () => {
  // Convert and group data
  //const groupedData = await convertDataAndGroup(dataArray);
  // Display modal with generated data
  //displayModal(generateModalContent(groupedData));
  console.log('className')
  console.log(className)
  console.log('data')
  conosle.log(data)
  const csvContent = "data:text/csv;charset=utf-8," +
    Object.keys(data[0]).join(",") + "\n" + // Header row
    data.map(entry => Object.values(entry).join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `EOSreport_${className}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// Function to convert data to a new format and group by class completion date
async function convertDataAndGroup(dataArray) {
  const groupedData = {};
  dataArray.forEach(obj => {
    const data = obj.data;
    const key = `${data.ClassHD ? 'HD' : data.ClassLD ? 'LD' : data.ClassVPS ? 'VPS' : 'Unknown'}_${data.ClassCompletionHD || data.ClassCompletionLD || data.ClassCompletionVPS}`;
    if (!groupedData[key]) {
      groupedData[key] = [];
    }
    const newObj = {
      "First Name": data.FirstName || "",
      "Last Name": data.LastName || "",
      "Company": data.Company || "",
      "VCERT Class": data.VCERTClass || "",
      "Email Address": data.Email || "",
      "Number of Challenges Completed": Object.keys(data).filter(key => key.startsWith('c') && data[key] === 1).length || 0,
      "Point Total": data[`TotalPoints${key}`] || 0,
      "Ranking": data.Ranking || "",
      "Class Type": key
    };
    groupedData[key].push(newObj);
  });
  return groupedData;
}

// Function to download CSV for a specific class data
function downloadCsv(className, data) {
  console.log('className')
  console.log(className)
  console.log('data')
  conosle.log(data)
  const csvContent = "data:text/csv;charset=utf-8," +
    Object.keys(data[0]).join(",") + "\n" + // Header row
    data.map(entry => Object.values(entry).join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `EOSreport_${className}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

}).catch(function(error) {
      console.error("Error:", error);
    });
});

</script>



</body>

</html>